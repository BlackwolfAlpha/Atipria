<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1.0"/>
  <title>Receipt • Atipria</title>

  <link rel="icon" type="image/x-icon" href="Data/webdesign/Atipria_logo-removebg-preview.png">
  <link rel="stylesheet" href="style.css">
  <link rel="stylesheet" href="receipt.css">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css" rel="stylesheet"/>

  <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>
  <script>
    emailjs.init("JU3WF_cvPQycgSfmp");

    const EMAILJS_SERVICE_ID          = "default_service";
    const EMAILJS_TEMPLATE_PAYMENT_ID = "template_qqsprwo";

    function buildReceiptUrl(txId) {
      const base = window.location.origin + window.location.pathname.replace(/[^/]+$/, "");
      return `${base}receipt.html?tx=${encodeURIComponent(txId)}`;
    }

    async function sendPaymentReceiptEmail({ txId, plan, price, paymentMethod, last4Digits, userName, email, dateISO }) {
      if (!email) return;
      const sentKey = `receipt_emailed_${txId}`;
      if (sessionStorage.getItem(sentKey) === "1") return;

      const params = {
        to_name:        userName || "Customer",
        to_email:       email,
        plan:           plan || "",
        amount:         typeof price === "number" ? `$${price.toFixed(2)}` : (price ?? ""),
        payment_method: paymentMethod || "",
        card_last4:     last4Digits ? `**** **** **** ${last4Digits}` : "",
        tx_id:          txId,
        date_str:       dateISO ? new Date(dateISO).toLocaleString() : "",
        receipt_url:    buildReceiptUrl(txId),
        from_name:      "Atipria"
      };

      try {
        await emailjs.send(EMAILJS_SERVICE_ID, EMAILJS_TEMPLATE_PAYMENT_ID, params);
        sessionStorage.setItem(sentKey, "1");
      } catch (err) {
        console.error("EmailJS receipt send failed:", err);
      }
    }
  </script>
</head>

<body class="receipt-page">
  <header class="header" style="justify-content:flex-start;">
    <div class="logo">
      <img src="Data/webdesign/Atipria_logo-removebg-preview.png" alt="Atipria Logo" class="logo-img">
      Atipria
    </div>
  </header>

  <main class="sheet">
    <section class="billboard">
      <div class="brand">
        <img src="Data/webdesign/Atipria_logo-removebg-preview.png" alt="Atipria Logo">
        <span class="brand-name">Atipria</span>
      </div>
      <div></div>
      <div class="company-meta">
        <span><strong>Receipt</strong></span>
        <span id="issueDate">Issued:</span>
        <span>Support: inovitefutureteam@gmail.com</span>
        <span>www.atipria.com</span>
      </div>
    </section>

    <section class="receipt-card">
      <h1 class="doc-title">Payment Receipt</h1>
      <p class="doc-sub">Thank you for your purchase. Below are your transaction details.</p>

      <div id="guard" class="receipt-guard">This receipt does not belong to the current user.</div>

      <div class="summary">
        <span class="tag">Transaction ID</span>
        <span class="val"><span id="txId" class="tx-badge">Loading…</span></span>
        <span class="tag">Plan</span>
        <span id="plan" class="val">Loading…</span>
      </div>

      <table class="detail-table" role="table">
        <tbody>
          <tr><th>Amount</th><td id="price" class="mono">Loading…</td></tr>
          <tr><th>Payment Method</th><td id="method">Loading…</td></tr>
          <tr><th>Card</th><td id="card" class="mono">Loading…</td></tr>
          <tr><th>Buyer</th><td id="buyer">Loading…</td></tr>
          <tr><th>Email</th><td id="email" class="mono">Loading…</td></tr>
          <tr><th>Date</th><td id="date">Loading…</td></tr>
        </tbody>
      </table>

      <div class="actions">
        <button class="btn-ghost" onclick="window.print()">
          <i class="fas fa-print" style="margin-right:8px;"></i>Print
        </button>
        <a class="btn-ghost" href="index.html">
          <i class="fas fa-home" style="margin-right:8px;"></i>Back to site
        </a>
        <a class="gradient-button" href="index.html#UserArea">
          Go to My Account
        </a>
      </div>
    </section>

    <div class="doc-foot">© 2025 InoviteFuture – Atipria. All rights reserved.</div>
  </main>

  <footer class="footer">
    <p>&copy; 2025 InoviteFuture - Atipria, All rights reserved.</p>
  </footer>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyChVy3pcEIBaUIAw3yXyABozLzeuAtMKNE",
      authDomain: "atipria-web.firebaseapp.com",
      projectId: "atipria-web",
      storageBucket: "atipria-web.appspot.com",
      messagingSenderId: "817765154697",
      appId: "1:817765154697:web:c50354276e11368c4fab58",
      measurementId: "G-K3LCQT6MZM"
    };

    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db   = firebase.firestore();

    const $ = (id)=>document.getElementById(id);
    const qs = new URLSearchParams(location.search);
    const tx = qs.get("tx") || "";
    const money  = (n)=> (typeof n === "number" ? "$"+n.toFixed(2) : "-");
    const toLocal= (d)=> d ? new Date(d).toLocaleString() : "-";

    document.getElementById("issueDate").textContent = "Issued: " + new Date().toLocaleString();

    (function showSession(){
      try {
        const raw = sessionStorage.getItem("lastReceipt");
        if (!raw) return;
        const r = JSON.parse(raw);
        if (r && r.txId === tx) {
          $("txId").textContent   = r.txId;
          $("plan").textContent   = r.plan || "-";
          $("price").textContent  = money(r.price);
          $("method").textContent = r.paymentMethod || "-";
          $("card").textContent   = r.last4Digits ? "•••• " + r.last4Digits : "-";
          $("buyer").textContent  = r.userName || "-";
          $("email").textContent  = r.email || "-";
          $("date").textContent   = toLocal(r.clientTime);

          sendPaymentReceiptEmail({
            txId: r.txId,
            plan: r.plan,
            price: r.price,
            paymentMethod: r.paymentMethod,
            last4Digits: r.last4Digits,
            userName: r.userName,
            email: r.email,
            dateISO: r.clientTime
          });
        }
      } catch {}
    })();

    (async function loadServer(){
      if (!tx) { alert("Missing transaction id."); return; }

      await new Promise((resolve)=>{
        const unsub = auth.onAuthStateChanged(async (u)=>{
          if (!u) {
            try { await auth.signInAnonymously(); } catch(e) { console.error(e); }
          }
          unsub(); resolve();
        });
      });

      try {
        const snap = await db.collection("purchases").doc(tx).get();
        if (!snap.exists) { alert("Transaction not found."); return; }
        const p = snap.data();

        const currentUid = auth.currentUser?.uid || "";
        const isOwner = (p.uidWeb && p.uidWeb === currentUid) || (p.uidUsers && p.uidUsers === currentUid);
        if (!isOwner) $("guard").style.display = "block";

        $("txId").textContent   = snap.id;
        $("plan").textContent   = p.plan || "-";
        $("price").textContent  = money(p.price);
        $("method").textContent = p.paymentMethod || "-";
        $("card").textContent   = p.last4Digits ? "•••• " + p.last4Digits : "-";
        $("buyer").textContent  = p.userName || "-";
        $("email").textContent  = p.email || "-";
        const ts = p.timestamp?.toDate ? p.timestamp.toDate().toISOString() : null;
        $("date").textContent   = toLocal(ts);

        sendPaymentReceiptEmail({
          txId: snap.id,
          plan: p.plan,
          price: p.price,
          paymentMethod: p.paymentMethod,
          last4Digits: p.last4Digits,
          userName: p.userName,
          email: p.email,
          dateISO: ts
        });

      } catch (e) {
        console.error(e);
        alert("Failed to load receipt: " + (e.message || ""));
      }
    })();
  </script>
</body>
</html>
